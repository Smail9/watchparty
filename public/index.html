<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Watch Party</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:0;padding:24px}
    .wrap{max-width:900px;margin:0 auto}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:12px 0}
    video{width:100%;max-height:70vh;background:#000;border-radius:12px}
    input,button{padding:8px 12px;border:1px solid #ccc;border-radius:10px}
    button{cursor:pointer}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Watch Party</h1>

    <!-- Salle -->
    <div class="row">
      <span>Salle :</span>
      <input id="roomInput" type="text" placeholder="amis" />
      <button id="joinBtn">Créer/Rejoindre</button>
      <button id="copyBtn">Copier le lien d'invitation</button>
    </div>

    <!-- Source commune -->
    <div class="row">
      <!-- Tu peux taper: /video-remote OU /proxy?u=http://... OU un https:// direct -->
      <input id="srcInput" type="url" placeholder="/video-remote ou /proxy?u=http://..." style="min-width:420px" />
      <button id="setSrcBtn">Définir la vidéo pour tous</button>
    </div>

    <video id="player" controls preload="metadata">
      <!-- Par défaut: proxy fixe -->
      <source src="/video-remote" type="video/mp4" />
    </video>

    <div class="row">
      <input type="file" id="filePicker" accept="video/*" />
      <button id="syncBtn">Me recaler</button>
    </div>
  </div>

  <script>
  let hls = null;

  function destroyHls() {
    if (hls) { try { hls.destroy(); } catch(_){} hls = null; }
  }

  function setPlayerSource(src, autoplay = false) {
    if (!src) return;
    console.log('Set player src ->', src);

    destroyHls();

    // HLS (m3u8)
    if (src.endsWith('.m3u8')) {
      if (window.Hls && Hls.isSupported()) {
        hls = new Hls({ enableWorker: true });
        hls.loadSource(src);
        hls.attachMedia(player);
        hls.on(Hls.Events.MANIFEST_PARSED, () => { if (autoplay) player.play().catch(()=>{}); });
      } else if (player.canPlayType('application/vnd.apple.mpegURL')) {
        // Safari natif HLS
        player.src = src;
        player.addEventListener('loadedmetadata', () => { if (autoplay) player.play().catch(()=>{}); }, { once: true });
      } else {
        alert("Ce navigateur ne supporte pas HLS et hls.js indisponible.");
      }
      return;
    }

    // MP4 / autre
    player.pause();
    player.removeAttribute('src');
    player.load();
    player.src = src;
    player.load();
    if (autoplay) player.play().catch(()=>{});
  }

  // Pense à détruire hls quand tu quittes la page
  window.addEventListener('beforeunload', destroyHls);
</script>

</body>
</html>
