<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Watch Party</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:0;padding:24px}
    .wrap{max-width:900px;margin:0 auto}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:12px 0}
    video{width:100%;max-height:70vh;background:#000;border-radius:12px}
    input,button{padding:8px 12px;border:1px solid #ccc;border-radius:10px}
    button{cursor:pointer}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Watch Party</h1>

    <div class="row">
      <span>Salle :</span>
      <input id="roomInput" type="text" placeholder="amis" />
      <button id="joinBtn">Créer/Rejoindre</button>
      <button id="copyBtn">Copier le lien d'invitation</button>
    </div>

    <div class="row">
      <!-- Tu peux taper /video-remote ou /proxy?u=http://... -->
      <input id="srcInput" type="url" placeholder="/video-remote OU /proxy?u=http://..." style="min-width:420px" />
      <button id="setSrcBtn">Définir la vidéo pour tous</button>
    </div>

    <video id="player" controls preload="metadata">
      <!-- Par défaut on met le proxy fixe -->
      <source src="/video-remote" type="video/mp4" />
    </video>

    <div class="row">
      <input type="file" id="filePicker" accept="video/*" />
      <button id="syncBtn">Me recaler</button>
    </div>
  </div>

  <script>
  // ... garde le reste tel quel (connect, applySync, etc.)

  function setPlayerSrc(src) {
    console.log('Setting player src to:', src);
    const wasPlaying = !player.paused;
    player.pause();
    player.removeAttribute('src');      // flush
    player.load();
    player.src = src;
    player.load();
    if (wasPlaying) player.play().catch(()=>{});
  }

  // ➜ Remplace tout TON handler actuel par ceci :
  setSrcBtn.addEventListener('click', () => {
    let input = (srcInput.value || '').trim();
    if (!input) return;

    // 1) Normaliser en URL relative même si l'utilisateur colle l'URL absolue
    try {
      const asURL = new URL(input, location.origin);
      if (asURL.origin === location.origin && asURL.pathname === '/proxy' && asURL.searchParams.has('u')) {
        // /proxy?u=... (absolu ou relatif) → recompose en RELATIF + encode systématique
        const inner = asURL.searchParams.get('u') || '';
        input = '/proxy?u=' + encodeURIComponent(inner);
      } else if (asURL.origin === location.origin && asURL.pathname === '/video-remote') {
        input = '/video-remote';
      } else if (input.startsWith('/proxy?u=')) {
        // cas /proxy?u=... collé en relatif → encode u si nécessaire
        const raw = input.slice(9);
        try { 
          // si c'est déjà encodé correctement, decode ne jette pas → on réencode proprement pour être sûr
          input = '/proxy?u=' + encodeURIComponent(decodeURIComponent(raw));
        } catch {
          input = '/proxy?u=' + encodeURIComponent(raw);
        }
      } else if (input.startsWith('http://') && location.protocol === 'https:')) {
        // Mixed content direct interdit → demander de passer par /proxy
        alert("Ton site est en HTTPS : utilise /proxy?u=http://… ou /video-remote.");
        return;
      }
    } catch {
      // si ce n'est pas une URL valable, on laisse tel quel (peut être /video-remote)
    }

    // 2) MAJ locale immédiate
    setPlayerSrc(input);

    // 3) Notifier tout le monde (y compris toi via syncState ultérieur)
    if (ws && ws.readyState === 1) {
      ws.send(JSON.stringify({ type: 'setSource', src: input }));
    }

    console.log('Source définie pour tous →', input);
  });

  // Bonus: logs d’erreur vidéo utiles
  player.addEventListener('error', () => {
    console.error('Video error:', player.error, 'currentSrc=', player.currentSrc);
  });
</script>

</body>
</html>
