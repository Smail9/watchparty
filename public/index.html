<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Watch Party</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:0;padding:24px}
    .wrap{max-width:900px;margin:0 auto}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:12px 0}
    video{width:100%;max-height:70vh;background:#000;border-radius:12px}
    input,button{padding:8px 12px;border:1px solid #ccc;border-radius:10px}
    button{cursor:pointer}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Watch Party</h1>

    <div class="row">
      <span>Salle :</span>
      <input id="roomInput" type="text" placeholder="amis" />
      <button id="joinBtn">Cr√©er/Rejoindre</button>
      <button id="copyBtn">Copier le lien d'invitation</button>
    </div>

    <video id="player" controls preload="metadata">
      <source src="sample.mp4" type="video/mp4" />
    </video>

    <div class="row">
      <input type="file" id="filePicker" accept="video/*" />
      <button id="syncBtn">Me recaler</button>
    </div>
  </div>

  <script>
    const player = document.getElementById('player');
    const roomInput = document.getElementById('roomInput');
    const joinBtn = document.getElementById('joinBtn');
    const copyBtn = document.getElementById('copyBtn');
    const filePicker = document.getElementById('filePicker');
    const syncBtn = document.getElementById('syncBtn');

    const urlParams = new URLSearchParams(location.search);
    const initialRoom = urlParams.get('room') || 'amis';
    roomInput.value = initialRoom;

    let ws = null;
    let isRemoteUpdate = false;

    function wsURL(room) {
      const proto = location.protocol === 'https:' ? 'wss' : 'ws';
      return `${proto}://${location.host}/watchparty?room=${encodeURIComponent(room)}`;
    }

    function connect(room) {
      if (ws) { try { ws.close(); } catch(_){} }
      ws = new WebSocket(wsURL(room));
      ws.onmessage = async (ev) => {
